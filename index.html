<script>
// ===== ROK10 mobile audio + asset hook (drop-in) =====
(function(){
  // --- Adjust only if you rename files (paths are case- and space-sensitive on GitHub Pages)
  var MUSIC_PATH = 'ROK10 game song perfectloop .mp3';
  var LOGO_PATH  = 'rok10_logo_transparent_soft (1).png';

  // Encode paths that contain spaces/() so Safari/iOS don’t choke
  function urlSafe(p){ try { return encodeURI(p); } catch(_){ return p; } }

  // 1) Attach logo if your build exposes window.logoImg (start screen & booth decal)
  if (typeof window !== 'undefined' && window.logoImg && !window.logoImg.src) {
    window.logoImg.crossOrigin = 'anonymous';
    window.logoImg.src = urlSafe(LOGO_PATH);
  }

  // 2) Ensure a global customAudio object exists for the game to detect
  if (typeof window.customAudio === 'undefined' || !window.customAudio) {
    window.customAudio = { audio:null, fileName:'' };
  }

  // Create (or reuse) an <audio> element for the custom track
  (function setupCustomMusic(){
    try{
      if (!window.customAudio.audio) {
        var au = new Audio(urlSafe(MUSIC_PATH));
        au.loop = true;
        au.preload = 'auto';
        try { au.setAttribute('playsinline',''); } catch(_){}
        window.customAudio.audio = au;
        window.customAudio.fileName = MUSIC_PATH;
        // If HUD exists, reflect that a custom track is available (but not yet playing)
        if (window.HUD && HUD.music) HUD.music.textContent = 'MUSIC: OFF (CUSTOM)';
      }
    }catch(e){ console.log('Custom music setup failed:', e); }
  })();

  // 3) Mobile audio bootstrap (no await/modern syntax; iOS-safe)
  var booted = false;
  function resumeAudio(){
    if (booted) return;
    booted = true;
    try{
      // Ensure/Resume WebAudio synth path
      if (window.music && typeof music.ensureInit === 'function') music.ensureInit();
      if (window.music && music.ctx && music.ctx.state === 'suspended') {
        try { music.ctx.resume(); } catch(_){}
      }

      // Prefer the custom track; if it plays, keep only that path active
      if (window.customAudio && customAudio.audio) {
        try { customAudio.audio.setAttribute('playsinline',''); } catch(_){}
        // Stop chiptune if it might be running
        try {
          if (window.music && music.running && typeof music.toggle === 'function') {
            music.toggle(false);
          }
        } catch(_){}
        var p = customAudio.audio.play();
        if (p && typeof p.then === 'function') {
          p.then(function(){
            if (window.HUD && HUD.music) HUD.music.textContent = 'MUSIC: ON (CUSTOM)';
          }).catch(function(err){
            console.log('Play blocked, tap again:', err);
            booted = false; // allow another tap
            var hint = document.getElementById('hint');
            if (hint) hint.textContent = 'Tap anywhere to enable sound (iOS policy)';
          });
        } else {
          if (window.HUD && HUD.music) HUD.music.textContent = 'MUSIC: ON (CUSTOM)';
        }
      } else if (window.music && typeof music.toggle === 'function') {
        // Fallback to chiptune
        music.toggle(true);
        if (window.HUD && HUD.music) HUD.music.textContent = 'MUSIC: ON';
      }
    }catch(e){
      console.log('resumeAudio error:', e);
      booted = false;
      var hint = document.getElementById('hint');
      if (hint) hint.textContent = 'Tap anywhere to enable sound (iOS policy)';
    }
  }

  // Hook Start button if present
  (function bindGestures(){
    var startBtn = document.getElementById('startBtn');
    if (startBtn) startBtn.addEventListener('click', resumeAudio, { once:true });
    // First interaction anywhere
    window.addEventListener('pointerdown', resumeAudio, { once:true });
    window.addEventListener('keydown',      resumeAudio, { once:true });
    // Try to resume context when returning to tab
    window.addEventListener('focus', function(){
      if (window.music && music.ctx && music.ctx.state === 'suspended') {
        try { music.ctx.resume(); } catch(_){}
      }
    });
  })();

  // 4) Tiny on‑page error indicator (helps debug on iPhone if anything breaks)
  window.onerror = function(msg, src, line, col){
    try{
      var el = document.getElementById('err');
      if (el){ el.style.display='block'; el.textContent = String(msg)+' @'+line+':'+col; }
    }catch(_){}
  };
})();
</script>
